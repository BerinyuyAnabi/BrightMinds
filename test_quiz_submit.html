<!DOCTYPE html>
<html>
<head>
    <title>Test Quiz Submit</title>
</head>
<body>
    <h2>Test Quiz Submission</h2>
    <p>This will test if the quiz API is working correctly.</p>

    <button onclick="testSubmit()">Test Submit Quiz 1</button>

    <div id="output" style="margin-top: 20px; padding: 20px; background: #f0f0f0; border-radius: 5px;"></div>

    <script>
        async function testSubmit() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Testing quiz submission...</p>';

            try {
                // First, login as a test user
                const loginResponse = await fetch('api/auth.php?action=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'getty1122',
                        password: 'password123'
                    })
                });

                const loginData = await loginResponse.json();
                output.innerHTML += `<p>Login: ${loginData.success ? '✅ Success' : '❌ Failed'}</p>`;

                if (!loginData.success) {
                    output.innerHTML += `<p>Error: ${loginData.message}</p>`;
                    return;
                }

                // Get child's current coins
                const statsResponse = await fetch('api/dashboard.php?action=stats');
                const statsData = await statsResponse.json();
                const coinsBefore = statsData.stats ? statsData.stats.coins : 0;
                output.innerHTML += `<p>Coins before: ${coinsBefore}</p>`;

                // Now submit a quiz
                // First get the quiz to see what questions it has
                const quizResponse = await fetch('api/quiz.php?action=get&id=1');
                const quizData = await quizResponse.json();

                output.innerHTML += `<p>Quiz loaded: ${quizData.success ? '✅' : '❌'}</p>`;

                if (!quizData.success) {
                    output.innerHTML += `<p>Error loading quiz: ${quizData.message}</p>`;
                    return;
                }

                // Build answers - answer first option for all questions
                const answers = {};
                quizData.quiz.questions.forEach(q => {
                    answers[q.questionID] = 'A'; // Answer A for all
                });

                output.innerHTML += `<p>Submitting answers for ${quizData.quiz.questions.length} questions...</p>`;

                // Submit the quiz
                const submitResponse = await fetch('api/quiz.php?action=submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        quizId: 1,
                        answers: answers,
                        timeSpent: 120
                    })
                });

                const submitData = await submitResponse.json();

                output.innerHTML += `<p>Quiz submission: ${submitData.success ? '✅ Success' : '❌ Failed'}</p>`;

                if (submitData.success) {
                    output.innerHTML += `<p><strong>Score:</strong> ${submitData.score}%</p>`;
                    output.innerHTML += `<p><strong>XP Earned:</strong> ${submitData.rewards.xp}</p>`;
                    output.innerHTML += `<p><strong>Coins Earned:</strong> ${submitData.rewards.coins}</p>`;

                    // Check coins after
                    const statsResponse2 = await fetch('api/dashboard.php?action=stats');
                    const statsData2 = await statsResponse2.json();
                    const coinsAfter = statsData2.stats ? statsData2.stats.coins : 0;

                    output.innerHTML += `<p>Coins after: ${coinsAfter}</p>`;
                    output.innerHTML += `<p><strong>Change:</strong> ${coinsAfter - coinsBefore} coins</p>`;

                    if (coinsAfter > coinsBefore) {
                        output.innerHTML += `<p style="color: green; font-weight: bold;">✅ SUCCESS! Coins were updated in database!</p>`;
                    } else {
                        output.innerHTML += `<p style="color: red; font-weight: bold;">❌ PROBLEM! Coins were not updated!</p>`;
                    }
                } else {
                    output.innerHTML += `<p style="color: red;">Error: ${submitData.message}</p>`;
                    output.innerHTML += `<pre>${JSON.stringify(submitData, null, 2)}</pre>`;
                }

            } catch (error) {
                output.innerHTML += `<p style="color: red;">Exception: ${error.message}</p>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>
